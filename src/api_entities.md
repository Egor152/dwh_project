
## CDM-слой

**Старая витрина - cdm.dm_settlement_report**

id - **уникальный** айдишник записи
restaurant_id - айдишник ресторана. 
restaurant_name - название ресторана
settlement_date - дата отчета
orders_count - количество заказов
orders_total_sum - сумма цен заказов
orders_bonus_payment_sum - сумма оплат бонусами
orders_bonus_granted_sum - сумма накопленных бонусов
order_processing_fee - сумма, удержанная компанией за обработку заказов
restaurant_reward_sum - сумма, которую необходимо перечислить ресторану.

**Витрина для проекта - cdm.dm_courier_ledger**
**Для чего нужна витрина** - содержит информацию о выплатах курьерам.

id — **уникальный** айдишник записи
courier_id — ID курьера, которому перечисляем.  **FK из dds.dm_couriers**
courier_name — Ф. И. О. курьера.
settlement_year — год отчёта.
settlement_month — месяц отчёта, где `1` — январь и `12` — декабрь.
orders_count — количество заказов за период (месяц).
orders_total_sum — общая стоимость заказов.
rate_avg — средний рейтинг курьера по оценкам пользователей.
order_processing_fee — сумма, удержанная компанией за обработку заказов, которая высчитывается как `orders_total_sum * 0.25`.
courier_order_sum — сумма, которую необходимо перечислить курьеру за доставленные им/ей заказы. За каждый доставленный заказ курьер должен получить некоторую сумму в зависимости от рейтинга (см. ниже).
courier_tips_sum — сумма, которую пользователи оставили курьеру в качестве чаевых.
courier_reward_sum — сумма, которую необходимо перечислить курьеру. Вычисляется как `courier_order_sum + courier_tips_sum * 0.95` (5% — комиссия за обработку платежа).

## DDS-слой

### Старые таблицы (из спринта)

**dds.srv_wf_settings** - сервисная таблица
id - **уникальный** айдишник записи
workflow_key - название процесса
workflow_settings - последний загруженный айдишник

**dds.dm_users** - хранит детальные данные о юзерах
id - **уникальный** айдишник записи
user_id - **уникальный** айдишник юзера
user_name - ФИО пользователя
user_login - логин пользователя

**dds.dm_restaurants** - хранит детальные данные о ресторанах
id - **уникальный** айдишник записи
restaurant_id - **уникальный** айдишник ресторана
restaurant_name - название ресторана
active_from - нужно для отслеживания изменений по ресторану. SCD 2
active_to - нужно для отслеживания изменений по ресторану. SCD 2

**dds.dm_products** - хранит данные о продуктах, которыми торгуют рестораны, вместе с их стоимостью
id - **уникальный** айдишник записи
restaurant_id - айдишник ресторана. FK из **dds.dm_restaurants**
product_id - **уникальный** айдишник продукта
product_name - название продукта
product_price - цена продукта
active_from - поле для отслеживания изменений. SCD 2
active_to - поле для отслеживания изменений. SCD 2

**dds.dm_timestamps** - хранит данные о дате и времени
id - **уникальный** айдишник записи
ts — отметка времени типа `timestamp`.
year— год типа `smallint`. Год должен быть больше или равен 2022 и меньше 2500.
month — месяц типа `smallint`. Он больше или равен 1 и меньше или равен 12.
day — день типа `smallint`. Должен быть больше или равен 1 и меньше или равен 31.
time — время типа `time`.
date — дата типа `date`.

**dds.dm_couriers** - хранит данные о курьерах из API
id - **уникальный** айдишник записи
courier_key - **уникальный** айдишник курьера
courier_name - фамилия и имя курьера

**dds.dm_orders** - хранит данные о заказах
id -**уникальный** айдишник записи 
order_key - **уникальный** идентификатор заказа 
order_status - статус заказа
user_id - **уникальный** айдишник юзера. **FK из dds.dm_users**
restaurant_id - **уникальный** айдишник ресторана. **FK из dds.dm_restaurants**
courier_id - **уникальный** айдишник курьера. **FK из dds.dm_couriers**
timestamp_id **уникальный** айдишник времени. **FK из dds.dm_timestamps**. Тянется обычный адйишник из таблицы, в dds.dm_timestamps это поле **id**

**dds.dm_deliveries** - хранит данные о доставках из API
id - **уникальный** айдишник записи
order_key - **уникальный** айдишник заказа
delivery_key - **уникальный** айдишник(код) доставки
delivery_sum - цена доставки
delivery_ts - дата и время доставки
order_ts - дата и время создания заказа
address - адрес доставки
courier_key - **уникальный** айдишник(код) курьера
rate - оценка доставки (целочисленное значение)
tip_sum - сумма чаевых курьеру

**dds.fct_couriers_deliveries** - это таблица фактов для измерений, описанных выше. 
id - **уникальный** айдишник записи 
order_id - **уникальный** идентификатор заказа. **FK из dds.dm_orders**
delivery_id - **уникальный** идентификатор доставки. **FK из dds.dm_deliveries**
order_ts - дата заказа
delivery_ts - дата доставки
delivery_price - цена доставки
courier_id - **уникальный** айдишник курьера. **FK из dds.dm_couriers**
courier_name - ФИО курьера
orders_count - количество заказов у курьера за период (месяц)
rate - оценка за доставку
tip_sum -  сумма чаевых


## STG-слой

**stg.srv_wf_settings** - сервисная таблица
id - **уникальный** айдишник записи
workflow_key - название процесса
workflow_settings - последний загруженный айдишник и дата
### Источник - БД PostgreSQL(оплата бонусами)

**stg.bonussystem_events** - таблица для хранения данных из `outbox`
id - **уникальный** айдишник записи 
event_ts - хранит дату события
event_type - хранит тип события
event_value хранит значение события

**stg.bonussystem_users** - таблица для хранения данных из `users` 
id - **уникальный** айдишник записи 
order_user_id - **уникальный** айдишник пользователя  

**stg.bonussystem_ranks** для хранения данных из `ranks`
id - **уникальный** айдишник записи 
name - название ранга
bonus_percent- процент бонуса к оплате
min_payment_threshold - минимальный порог платежа

### Источник - БД MongoDB(хранит данные о заказах и ресторанах)

**stg.ordersystem_orders** - хранит данные о заказах
id - **уникальный** айдишник записи 
object_id - **уникальный** айдишник заказа 
object_value - хранит документ из MongoDB. Данные о заказе (JSON с ценой, айдишником заказа, датой заказа и т.д. )
update_ts - дата заказа

**stg.ordersystem_restaurants** - хранит данные о ресторанах
id - **уникальный** айдишник записи 
object_id - **уникальный** айдишник ресторана
object_value - хранит документ из MongoDB. Данные в JSON-е о клиенте: логин, ФИО, дата
update_ts  - дата оплаты

**stg.ordersystem_users** - хранит данные о клиентах
id - **уникальный** айдишник записи 
object_id - **уникальный** айдишник клиента  
object_value - хранит документ из MongoDB. Данные в JSON-е о клиенте: логин, ФИО, дата 
update_ts - дата оплаты

### Источник - API. Метод /restaurants. Рестораны совпадают с теми, которые уже есть в DWH 
**stg.api_restaurants** - хранит данные о ресторанах. Не думаю, что нужно добавлять ее
id - **уникальный** айдишник записи 
object_id - **уникальный** айдишник ресторана
object_value - Данные в JSON-е о ресторане: **уникальный** айдишник ресторана, название ресторана

### Источник - API. Метод /couriers

**stg.api_couriers** - хранит данные о курьерах
id - **уникальный** айдишник записи 
object_id -  **уникальный** айдишник курьера
object_value - Данные в JSON-е о курьере: **уникальный** айдишник курьера, фамилия и имя курьера

### Источник - API. Метод /deliveries


**stg.api_deliveries** - хранит данные о доставках
id - **уникальный** айдишник записи 
object_id -  **уникальный** айдишник доставки
object_value - Данные в JSON-е о заказе: **уникальный** айдишник заказа, дата заказа, айдишник курьера, адрес доставки, дата и время совершения доставки, оценка за доставку, сумма заказа, сумма чаевых. 
	**Поле сумма заказа не понадобится для выполнения проекта, поскольку это число и так можно получить из подсистемы заказов (MongoDB).**

delivery_ts - дата доставки. Это поле позволит сразу отличать новые доставки от старых